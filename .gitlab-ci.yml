default:
  image: debian:sid

stages:
  - test
  - build

test:
  before_script:
    - apt-get update && apt-get install -y bats device-tree-compiler
  script:
    - cd test && bash bootstrap.sh
  stage: test

build:
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - $CI_JOB_NAME-$CI_COMMIT_REF_NAME/*
    when: on_success
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends build-essential debhelper-compat device-tree-compiler devscripts git git-buildpackage
  script:
    - git checkout -B "$CI_BUILD_REF_NAME" "$CI_BUILD_REF"
    - git fetch origin +refs/heads/upstream:refs/tags/upstream
    - gbp export-orig --upstream-tree=origin/upstream
    - dpkg-buildpackage --post-clean --no-sign -i -I
    - mkdir $CI_JOB_NAME-$CI_COMMIT_REF_NAME && cp -vf ../olinuxino-overlays_*.* ./$CI_JOB_NAME-$CI_COMMIT_REF_NAME/
  stage: build
